import { describe, it, expect } from 'vitest'
import { questionHelpers, questionUtils } from '../questionHelpers'
import type { Question } from '@/types/types'

describe('questionHelpers', () => {
  const validQuestion: Question = {
    question_number: 1,
    question_text_en: 'What is AWS?',
    question_text_zh: '什麼是 AWS？',
    options_en: ['Amazon Web Services', 'Amazon Web Storage', 'Amazon Web System', 'Amazon Web Security'],
    options_zh: ['亞馬遜網路服務', '亞馬遜網路儲存', '亞馬遜網路系統', '亞馬遜網路安全'],
    correct_answer: 'A',
    explanation: 'AWS stands for Amazon Web Services.',
    tips: ['Tip 1', 'Tip 2']
  }

  const multipleChoiceQuestion: Question = {
    question_number: 2,
    question_text_en: 'Which are AWS services?',
    question_text_zh: '以下哪些是 AWS 服務？',
    options_en: ['EC2', 'S3', 'RDS', 'Azure VM'],
    options_zh: ['EC2', 'S3', 'RDS', 'Azure VM'],
    correct_answer: 'ABC',
    explanation: 'EC2, S3, and RDS are AWS services.',
    tips: []
  }

  describe('getAnswerType', () => {
    it('應該正確識別單選題', () => {
      expect(questionHelpers.getAnswerType('A')).toBe('single')
      expect(questionHelpers.getAnswerType('B')).toBe('single')
      expect(questionHelpers.getAnswerType('C')).toBe('single')
      expect(questionHelpers.getAnswerType('D')).toBe('single')
    })

    it('應該正確識別多選題', () => {
      expect(questionHelpers.getAnswerType('AB')).toBe('multiple')
      expect(questionHelpers.getAnswerType('ABC')).toBe('multiple')
      expect(questionHelpers.getAnswerType('ABCD')).toBe('multiple')
      expect(questionHelpers.getAnswerType('BD')).toBe('multiple')
    })

    it('應該處理帶空白的答案', () => {
      expect(questionHelpers.getAnswerType(' A ')).toBe('single')
      expect(questionHelpers.getAnswerType(' AB ')).toBe('multiple')
      expect(questionHelpers.getAnswerType('\tBC\n')).toBe('multiple')
    })

    it('應該處理小寫答案', () => {
      expect(questionHelpers.getAnswerType('a')).toBe('single')
      expect(questionHelpers.getAnswerType('abc')).toBe('multiple')
      expect(questionHelpers.getAnswerType('bD')).toBe('multiple')
    })

    it('應該處理無效輸入', () => {
      expect(questionHelpers.getAnswerType('')).toBe('single')
      expect(questionHelpers.getAnswerType(null as any)).toBe('single')
      expect(questionHelpers.getAnswerType(undefined as any)).toBe('single')
      expect(questionHelpers.getAnswerType(123 as any)).toBe('single')
    })
  })

  describe('parseCorrectAnswers', () => {
    it('應該正確解析單選答案', () => {
      expect(questionHelpers.parseCorrectAnswers('A')).toEqual(['A'])
      expect(questionHelpers.parseCorrectAnswers('B')).toEqual(['B'])
      expect(questionHelpers.parseCorrectAnswers('C')).toEqual(['C'])
    })

    it('應該正確解析多選答案', () => {
      expect(questionHelpers.parseCorrectAnswers('AB')).toEqual(['A', 'B'])
      expect(questionHelpers.parseCorrectAnswers('ABC')).toEqual(['A', 'B', 'C'])
      expect(questionHelpers.parseCorrectAnswers('BD')).toEqual(['B', 'D'])
    })

    it('應該對答案進行排序', () => {
      expect(questionHelpers.parseCorrectAnswers('CBA')).toEqual(['A', 'B', 'C'])
      expect(questionHelpers.parseCorrectAnswers('DB')).toEqual(['B', 'D'])
      expect(questionHelpers.parseCorrectAnswers('DCBA')).toEqual(['A', 'B', 'C', 'D'])
    })

    it('應該處理帶空白的答案', () => {
      expect(questionHelpers.parseCorrectAnswers(' A B C ')).toEqual(['A', 'B', 'C'])
      expect(questionHelpers.parseCorrectAnswers('\tAB\n')).toEqual(['A', 'B'])
    })

    it('應該處理小寫答案', () => {
      expect(questionHelpers.parseCorrectAnswers('abc')).toEqual(['A', 'B', 'C'])
      expect(questionHelpers.parseCorrectAnswers('bD')).toEqual(['B', 'D'])
    })

    it('應該過濾無效字元', () => {
      expect(questionHelpers.parseCorrectAnswers('A1B2C')).toEqual(['A', 'B', 'C'])
      expect(questionHelpers.parseCorrectAnswers('A,B;C')).toEqual(['A', 'B', 'C'])
      expect(questionHelpers.parseCorrectAnswers('A-B_C')).toEqual(['A', 'B', 'C'])
    })

    it('應該處理無效輸入', () => {
      expect(questionHelpers.parseCorrectAnswers('')).toEqual([])
      expect(questionHelpers.parseCorrectAnswers(null as any)).toEqual([])
      expect(questionHelpers.parseCorrectAnswers(undefined as any)).toEqual([])
      expect(questionHelpers.parseCorrectAnswers('123')).toEqual([])
    })
  })

  describe('validateQuestion', () => {
    it('應該驗證有效的題目', () => {
      expect(questionHelpers.validateQuestion(validQuestion)).toBe(true)
      expect(questionHelpers.validateQuestion(multipleChoiceQuestion)).toBe(true)
    })

    it('應該拒絕 null 或 undefined', () => {
      expect(questionHelpers.validateQuestion(null)).toBe(false)
      expect(questionHelpers.validateQuestion(undefined)).toBe(false)
      expect(questionHelpers.validateQuestion('not an object')).toBe(false)
      expect(questionHelpers.validateQuestion(123)).toBe(false)
    })

    it('應該拒絕缺少必要欄位的題目', () => {
      const incompleteQuestion = { ...validQuestion }
      delete (incompleteQuestion as any).question_number
      expect(questionHelpers.validateQuestion(incompleteQuestion)).toBe(false)

      const noOptions = { ...validQuestion }
      delete (noOptions as any).options_en
      expect(questionHelpers.validateQuestion(noOptions)).toBe(false)
    })

    it('應該驗證 question_number 為正數', () => {
      const invalidNumber = { ...validQuestion, question_number: 0 }
      expect(questionHelpers.validateQuestion(invalidNumber)).toBe(false)

      const negativeNumber = { ...validQuestion, question_number: -1 }
      expect(questionHelpers.validateQuestion(negativeNumber)).toBe(false)

      const stringNumber = { ...validQuestion, question_number: '1' as any }
      expect(questionHelpers.validateQuestion(stringNumber)).toBe(false)
    })

    it('應該驗證文字欄位為字串', () => {
      const invalidTextEn = { ...validQuestion, question_text_en: 123 as any }
      expect(questionHelpers.validateQuestion(invalidTextEn)).toBe(false)

      const invalidTextZh = { ...validQuestion, question_text_zh: null as any }
      expect(questionHelpers.validateQuestion(invalidTextZh)).toBe(false)
    })

    it('應該驗證選項陣列格式', () => {
      const invalidOptionsEn = { ...validQuestion, options_en: 'not an array' as any }
      expect(questionHelpers.validateQuestion(invalidOptionsEn)).toBe(false)

      const emptyOptions = { ...validQuestion, options_en: [] }
      expect(questionHelpers.validateQuestion(emptyOptions)).toBe(false)

      const mismatchedOptionsLength = {
        ...validQuestion,
        options_zh: ['選項1', '選項2'] // 比 options_en 少
      }
      expect(questionHelpers.validateQuestion(mismatchedOptionsLength)).toBe(false)
    })

    it('應該驗證選項內容為字串', () => {
      const invalidOptionContent = {
        ...validQuestion,
        options_en: ['Valid option', 123, 'Another valid option'] as any
      }
      expect(questionHelpers.validateQuestion(invalidOptionContent)).toBe(false)
    })

    it('應該驗證正確答案格式', () => {
      const emptyAnswer = { ...validQuestion, correct_answer: '' }
      expect(questionHelpers.validateQuestion(emptyAnswer)).toBe(false)

      const nullAnswer = { ...validQuestion, correct_answer: null as any }
      expect(questionHelpers.validateQuestion(nullAnswer)).toBe(false)

      const numberAnswer = { ...validQuestion, correct_answer: 1 as any }
      expect(questionHelpers.validateQuestion(numberAnswer)).toBe(false)
    })

    it('應該驗證正確答案對應有效選項', () => {
      const invalidAnswer = { ...validQuestion, correct_answer: 'E' } // 超出選項範圍
      expect(questionHelpers.validateQuestion(invalidAnswer)).toBe(false)

      const partiallyInvalidAnswer = { ...validQuestion, correct_answer: 'AE' }
      expect(questionHelpers.validateQuestion(partiallyInvalidAnswer)).toBe(false)
    })

    it('應該驗證 explanation 為字串', () => {
      const nullExplanation = { ...validQuestion, explanation: null as any }
      expect(questionHelpers.validateQuestion(nullExplanation)).toBe(false)

      const numberExplanation = { ...validQuestion, explanation: 123 as any }
      expect(questionHelpers.validateQuestion(numberExplanation)).toBe(false)

      // 空字串是有效的
      const emptyExplanation = { ...validQuestion, explanation: '' }
      expect(questionHelpers.validateQuestion(emptyExplanation)).toBe(true)
    })

    it('應該驗證 tips 為字串陣列', () => {
      const notArrayTips = { ...validQuestion, tips: 'not an array' as any }
      expect(questionHelpers.validateQuestion(notArrayTips)).toBe(false)

      const invalidTipContent = { ...validQuestion, tips: ['valid tip', 123, 'another tip'] as any }
      expect(questionHelpers.validateQuestion(invalidTipContent)).toBe(false)

      // 空陣列是有效的
      const emptyTips = { ...validQuestion, tips: [] }
      expect(questionHelpers.validateQuestion(emptyTips)).toBe(true)
    })
  })

  describe('getQuestionText', () => {
    it('應該根據語言返回正確的題目文字', () => {
      expect(questionHelpers.getQuestionText(validQuestion, 'zh')).toBe('什麼是 AWS？')
      expect(questionHelpers.getQuestionText(validQuestion, 'en')).toBe('What is AWS?')
    })

    it('應該處理不同的語言參數', () => {
      expect(questionHelpers.getQuestionText(validQuestion, 'zh')).toBe(validQuestion.question_text_zh)
      expect(questionHelpers.getQuestionText(validQuestion, 'en')).toBe(validQuestion.question_text_en)
    })
  })

  describe('getOptions', () => {
    it('應該根據語言返回正確的選項陣列', () => {
      const zhOptions = questionHelpers.getOptions(validQuestion, 'zh')
      expect(zhOptions).toEqual(['亞馬遜網路服務', '亞馬遜網路儲存', '亞馬遜網路系統', '亞馬遜網路安全'])

      const enOptions = questionHelpers.getOptions(validQuestion, 'en')
      expect(enOptions).toEqual(['Amazon Web Services', 'Amazon Web Storage', 'Amazon Web System', 'Amazon Web Security'])
    })

    it('應該返回獨立的陣列實例', () => {
      const options1 = questionHelpers.getOptions(validQuestion, 'zh')
      const options2 = questionHelpers.getOptions(validQuestion, 'zh')

      expect(options1).toEqual(options2)
      expect(options1).not.toBe(options2) // 不是同一個物件參考
    })
  })
})

describe('questionUtils (擴展功能)', () => {
  const sampleQuestions: Question[] = [
    {
      question_number: 1,
      question_text_en: 'What is AWS EC2?',
      question_text_zh: '什麼是 AWS EC2？',
      options_en: ['Virtual Machine', 'Database', 'Storage', 'Network'],
      options_zh: ['虛擬機器', '資料庫', '儲存', '網路'],
      correct_answer: 'A',
      explanation: 'EC2 provides virtual computing environments.',
      tips: ['EC2 是彈性運算雲端服務']
    },
    {
      question_number: 2,
      question_text_en: 'Which AWS services provide storage?',
      question_text_zh: '哪些 AWS 服務提供儲存功能？',
      options_en: ['S3', 'EBS', 'EC2', 'Lambda'],
      options_zh: ['S3', 'EBS', 'EC2', 'Lambda'],
      correct_answer: 'AB',
      explanation: 'S3 and EBS are storage services.',
      tips: ['S3 用於物件儲存', 'EBS 用於區塊儲存']
    }
  ]

  describe('formatOptionsWithLabels', () => {
    it('應該為選項添加 A、B、C、D 標籤', () => {
      const options = ['Option 1', 'Option 2', 'Option 3']
      const formatted = questionUtils.formatOptionsWithLabels(options)

      expect(formatted).toEqual([
        'A. Option 1',
        'B. Option 2',
        'C. Option 3'
      ])
    })

    it('應該處理空陣列', () => {
      expect(questionUtils.formatOptionsWithLabels([])).toEqual([])
    })

    it('應該處理大量選項', () => {
      const manyOptions = Array.from({ length: 10 }, (_, i) => `Option ${i + 1}`)
      const formatted = questionUtils.formatOptionsWithLabels(manyOptions)

      expect(formatted[0]).toBe('A. Option 1')
      expect(formatted[9]).toBe('J. Option 10')
    })
  })

  describe('getOptionLabels', () => {
    it('應該生成正確數量的選項標籤', () => {
      expect(questionUtils.getOptionLabels(4)).toEqual(['A', 'B', 'C', 'D'])
      expect(questionUtils.getOptionLabels(2)).toEqual(['A', 'B'])
      expect(questionUtils.getOptionLabels(6)).toEqual(['A', 'B', 'C', 'D', 'E', 'F'])
    })

    it('應該處理零和負數', () => {
      expect(questionUtils.getOptionLabels(0)).toEqual([])
      expect(questionUtils.getOptionLabels(-1)).toEqual([])
    })
  })

  describe('validateQuestions', () => {
    it('應該驗證有效的題目陣列', () => {
      const result = questionUtils.validateQuestions(sampleQuestions)

      expect(result.isValid).toBe(true)
      expect(result.errors).toEqual([])
      expect(result.validQuestions).toEqual(sampleQuestions)
    })

    it('應該拒絕非陣列輸入', () => {
      const result = questionUtils.validateQuestions('not an array')

      expect(result.isValid).toBe(false)
      expect(result.errors).toContain('題目資料必須是陣列格式')
      expect(result.validQuestions).toEqual([])
    })

    it('應該拒絕空陣列', () => {
      const result = questionUtils.validateQuestions([])

      expect(result.isValid).toBe(false)
      expect(result.errors).toContain('題目陣列不能為空')
      expect(result.validQuestions).toEqual([])
    })

    it('應該識別無效題目', () => {
      const invalidQuestions = [
        sampleQuestions[0], // 有效
        { invalid: 'question' }, // 無效
        sampleQuestions[1] // 有效
      ]

      const result = questionUtils.validateQuestions(invalidQuestions)

      expect(result.isValid).toBe(false)
      expect(result.errors).toContain('第 2 題格式無效')
      expect(result.validQuestions).toHaveLength(2)
    })

    it('應該檢測重複的題目編號', () => {
      const duplicateQuestions = [
        sampleQuestions[0],
        { ...sampleQuestions[1], question_number: 1 } // 重複編號
      ]

      const result = questionUtils.validateQuestions(duplicateQuestions)

      expect(result.isValid).toBe(false)
      expect(result.errors).toContain('題目編號 1 重複')
    })

    it('應該對有效題目進行排序', () => {
      const unorderedQuestions = [
        { ...sampleQuestions[1], question_number: 3 },
        { ...sampleQuestions[0], question_number: 1 },
        { ...sampleQuestions[1], question_number: 2 }
      ]

      const result = questionUtils.validateQuestions(unorderedQuestions)

      expect(result.isValid).toBe(true)
      expect(result.validQuestions.map(q => q.question_number)).toEqual([1, 2, 3])
    })
  })

  describe('searchQuestions', () => {
    it('應該在題目文字中搜尋', () => {
      const results = questionUtils.searchQuestions(sampleQuestions, 'EC2', 'en')
      expect(results).toHaveLength(1)
      expect(results[0]?.question_number).toBe(1)
    })

    it('應該在中文題目文字中搜尋', () => {
      const results = questionUtils.searchQuestions(sampleQuestions, 'EC2', 'zh')
      expect(results).toHaveLength(1)
      expect(results[0]?.question_number).toBe(1)
    })

    it('應該在選項中搜尋', () => {
      const results = questionUtils.searchQuestions(sampleQuestions, 'S3', 'en')
      expect(results).toHaveLength(1)
      expect(results[0]?.question_number).toBe(2)
    })

    it('應該在詳解中搜尋', () => {
      const results = questionUtils.searchQuestions(sampleQuestions, 'virtual', 'en')
      expect(results).toHaveLength(1)
      expect(results[0]?.question_number).toBe(1)
    })

    it('應該在提示中搜尋', () => {
      const results = questionUtils.searchQuestions(sampleQuestions, '彈性', 'zh')
      expect(results).toHaveLength(1)
      expect(results[0]?.question_number).toBe(1)
    })

    it('應該進行不區分大小寫的搜尋', () => {
      const results1 = questionUtils.searchQuestions(sampleQuestions, 'AWS', 'en')
      const results2 = questionUtils.searchQuestions(sampleQuestions, 'aws', 'en')
      const results3 = questionUtils.searchQuestions(sampleQuestions, 'Aws', 'en')

      expect(results1).toHaveLength(1)
      expect(results2).toHaveLength(1)
      expect(results3).toHaveLength(1)
    })

    it('應該處理空白搜尋詞', () => {
      const results1 = questionUtils.searchQuestions(sampleQuestions, '', 'en')
      const results2 = questionUtils.searchQuestions(sampleQuestions, '   ', 'en')

      expect(results1).toEqual(sampleQuestions)
      expect(results2).toEqual(sampleQuestions)
    })

    it('應該處理沒有匹配結果的情況', () => {
      const results = questionUtils.searchQuestions(sampleQuestions, 'nonexistent', 'en')
      expect(results).toEqual([])
    })

    it('應該返回多個匹配結果', () => {
      const results = questionUtils.searchQuestions(sampleQuestions, 'AWS', 'en')
      expect(results).toHaveLength(1) // 只有第一題包含 'AWS'

      // 搜尋更通用的詞
      const commonResults = questionUtils.searchQuestions(sampleQuestions, 'service', 'en')
      expect(commonResults.length).toBeGreaterThanOrEqual(1)
    })
  })
})